{% extends "layout/base.html" %}
{% block title %}Thực đơn{% endblock %}
{% block content %}
<div class="mt-4 p-5 bg-light border rounded">
    <h3>Thực đơn nhà hàng</h3>

    <button class="btn btn-primary mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#addDishContainer"
            aria-expanded="false" aria-controls="addDishContainer">
        Thêm món ăn
    </button>


    <form class="" action="/owner/menu">
        <div class="mb-3">
            <input type="text" name="keyword" class="form-control" id="searchDish" placeholder="Tìm món ăn theo tên..."
                   value="{{ request.args.get('keyword', '') }}">
        </div>
    </form>
    <div class="collapse mb-3" id="addDishContainer">
        <div class="card card-body">
            <form enctype="multipart/form-data" id="addDishForm">
                <div class="mb-3">
                    <label for="name" class="form-label">Tên món</label>
                    <input type="text" class="form-control" name="name" id="name" required>
                </div>
                <div class="mb-3">
                    <label for="categorySelect" class="form-label">Loại món</label>
                    <select class="form-select" id="categorySelect" name="category">
                        <option value="" selected>Chọn category...</option>
                        {% for cat in categories %}
                            <option value="{{ cat.category_id }}">{{ cat.name }}</option>
                        {% endfor %}
                        <option value="new">+ Thêm category mới</option>
                    </select>

                    <!-- input này ẩn mặc định, chỉ hiện khi thêm mới -->
                    <input type="text" class="form-control mt-2 d-none" id="newCategoryInput"
                           placeholder="Nhập tên category mới" name="new_category">
                </div>
                <div class="mb-3">
                    <label for="note" class="form-label">Ghi chú</label>
                    <input type="text" class="form-control" name="note" id="note">
                </div>
                <div class="mb-3">
                    <label for="dishImage" class="form-label">Hình ảnh</label>
                    <input type="file" class="form-control" name="image" id="dishImage">
                </div>
                <div class="mb-3">
                    <label for="price" class="form-label">Giá</label>
                    <input type="number" class="form-control" name="price" id="price" required>
                </div>
                <button type="submit" class="btn btn-success">Thêm món</button>
            </form>
        </div>
    </div>

    {% if dishes %}
    <div style="max-height: 600px; overflow-y: auto;">  <!-- scroll khi quá chiều cao -->
        <table class="table table-striped table-bordered align-middle" id="dishesTable">
            <thead>
            <tr>
                <th class="text-center">Tên món</th>
                <th style="width:150px;" class="text-center">Mô tả</th>
                <th class="text-center">Giá</th>
                <th class="text-center">Category</th>
                <th class="text-center">Xóa</th>
            </tr>
            </thead>
            <tbody id="dishesTableBody">
            {% for dish in dishes %}
            <tr class="dish-row" data-id="{{ dish.dish_id }}"
                data-name="{{ dish.name }}"
                data-note="{{ dish.note }}"
                data-price="{{ dish.price }}"
                data-category="{{ dish.category.name if dish.category else '' }}"
                data-image="{{ dish.image }}"
                data-active="{{ '1' if dish.is_available else '0' }}">
                <td class="text-center">{{ dish.name }}</td>
                <td class="text-center text-truncate" style="max-width:150px;">{{ dish.note or "Chưa có mô tả" }}</td>
                <td class="text-center">{{ dish.price }}đ</td>
                <td class="text-center">{{ dish.category.name if dish.category else "-" }}</td>
                <td class="text-center">
                    <button type="button" class="btn btn-danger btn-sm middle">Xóa</button>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p id="noDishesMsg">Chưa có món ăn nào.</p>
    {% endif %}


    <!-- Form chỉnh sửa món ăn -->
    <div class="collapse mt-4" id="editDishForm">
        <div class="card card-body">
            <h5>Chỉnh sửa món ăn</h5>
            <form method="POST" action="" enctype="multipart/form-data">
                <input type="hidden" name="dish_id" id="editDishId">
                <div class="mb-3">
                    <label for="editName" class="form-label">Tên món</label>
                    <input type="text" class="form-control" name="name" id="editName" required>
                </div>
                <div class="mb-3">
                    <label for="editCategory" class="form-label">Loại món</label>
                    <input type="text" class="form-control" name="category" id="editCategory">
                </div>
                <div class="mb-3">
                    <label for="editNote" class="form-label">Mô tả</label>
                    <input type="text" class="form-control" name="note" id="editNote">
                </div>
                <div class="mb-3">
                    <label for="editPrice" class="form-label">Giá</label>
                    <input type="number" class="form-control" name="price" id="editPrice" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Hình ảnh hiện tại</label><br>
                    <img id="editImagePreview" src="" alt="Hình ảnh"
                         style="width:100px; height:100px; object-fit:cover; border-radius:5px;">
                </div>
                <div class="mb-3">
                    <label for="editImage" class="form-label">Thay hình ảnh mới</label>
                    <input type="file" class="form-control" name="image" id="editImage">
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="editActive" name="is_available">
                    <label class="form-check-label" for="editActive">Active</label>
                </div>
                <button type="submit" class="btn btn-success">Lưu thay đổi</button>
            </form>
        </div>
    </div>

</div>

<script src="{{ url_for('static', filename='js/menu.js') }}"></script>
{% endblock %}

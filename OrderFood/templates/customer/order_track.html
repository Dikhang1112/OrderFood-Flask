<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>Theo dõi đơn #{{ order.order_id }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <!-- CSS riêng -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/customer/order_track.css') }}">
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="d-flex align-items-center mb-3">
      <a class="btn btn-outline-secondary me-2" href="{{ url_for('index') }}">← Trang chủ</a>
      <h4 class="m-0">Theo dõi đơn hàng #{{ order.order_id }}</h4>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for cat, msg in messages %}
          <div class="alert alert-{{ cat }}">{{ msg }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="card shadow-sm">
      <div class="card-body">
        <div class="timeline" style="--active-idx: {{ active_idx }}"></div>

        <div class="steps">
          <div class="step {{ 'active' if active_idx == 0 }}">
            <div class="circle">1</div>
            <div class="label">Đã thanh toán</div>
          </div>
          <div class="step {{ 'active' if active_idx == 1 }}">
            <div class="circle">2</div>
            <div class="label">Xác nhận đơn</div>
          </div>
          <div class="step {{ 'active' if active_idx == 2 }}">
            <div class="circle">3</div>
            <div class="label">{{ last_label }}</div>
          </div>
        </div>

        <hr>

        <div class="row g-3">
          <div class="col-md-6">
            <h6 class="text-muted mb-1">Thông tin đơn</h6>
            <p class="mb-0">
              Nhà hàng: <strong>{{ order.restaurant.name if order.restaurant else '—' }}</strong><br>
              Tổng tiền: <strong>{{ "{:,.0f}".format(order.total_price or 0) }} đ</strong><br>
              Tạo lúc: <strong>{{ order.created_date }}</strong>
            </p>
          </div>
        </div>

        <div class="mt-4 d-flex gap-2">
          <a class="btn btn-primary" href="{{ url_for('customer.customer_home') }}">Tiếp tục đặt món</a>
          <a class="btn btn-outline-secondary" href="{{ url_for('customer.restaurant_detail', restaurant_id=order.restaurant_id) }}">Xem nhà hàng</a>
        </div>
      </div>
    </div>

    {% set is_completed = (status_str|default('') == 'COMPLETED') %}
    {% if is_completed %}
      {% if not has_rated|default(false) %}
        <div class="card shadow-sm mt-4">
          <div class="card-body">
            <h5 class="mb-3">Đánh giá đơn hàng</h5>
            <form method="post" action="{{ url_for('customer.order_rate', order_id=order.order_id) }}">
              <div class="rating-stars mb-3" data-selected="0">
                <button type="button" class="star" data-val="1" aria-label="1 sao">★</button>
                <button type="button" class="star" data-val="2" aria-label="2 sao">★</button>
                <button type="button" class="star" data-val="3" aria-label="3 sao">★</button>
                <button type="button" class="star" data-val="4" aria-label="4 sao">★</button>
                <button type="button" class="star" data-val="5" aria-label="5 sao">★</button>
                <input type="hidden" name="rating" id="rating-input" value="0">
              </div>
              <div class="mb-3">
                <label class="form-label">Nhận xét (tuỳ chọn)</label>
                <textarea class="form-control" name="comment" rows="3" maxlength="255" placeholder="Cảm nhận của bạn..."></textarea>
              </div>
              <button class="btn btn-success" type="submit">Gửi đánh giá</button>
            </form>
          </div>
        </div>
      {% else %}
        <div class="card shadow-sm mt-4">
          <div class="card-body">
            <h5 class="mb-2">Bạn đã đánh giá</h5>
            <div class="rating-stars rating-readonly fs-3" aria-label="Đã đánh giá {{ user_rating|default(0) }} sao">
              {% for i in range(1,6) %}
                <span class="star {{ 'on' if i <= user_rating|default(0) else '' }}">★</span>
              {% endfor %}
              <span class="ms-2 text-muted">{{ user_rating|default(0) }}/5</span>
            </div>
            {% if user_comment|default('') %}
              <p class="mt-2 mb-0">{{ user_comment }}</p>
            {% endif %}
          </div>
        </div>
      {% endif %}
    {% endif %}
  </div>

  <!-- JS riêng -->
  <script src="{{ url_for('static', filename='js/customer/order_track.js') }}"></script>
</body>
</html>
